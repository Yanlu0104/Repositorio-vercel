<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fase 28 - Ordem de Opera√ß√µes</title>
    
<style>
        /* --- ESTILOS VISUAIS --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif; 
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: hidden;
        }

        body {
            /* Fundo com a imagem da ilha noturna (ajuste o path se necess√°rio) */
            background-image: url('imagem_8/tudo_82.jpg'); 
            background-size: cover; 
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px; 
        }

        ::-webkit-scrollbar { display: none; }

        .game-container {
            /* Fundo totalmente transparente */
            background: rgba(0, 0, 0, 0); 
            border-radius: 35px; 
            padding: 30px; 
            max-width: 900px; 
            width: 100%;
            box-shadow: 0 0 30px rgba(255, 195, 0, 0.6), 0 0 0 2px rgba(255, 195, 0, 0.3); 
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto; 
            max-height: 98vh; 
            border: 2px solid #FFC300; 
        }

        /* --- ESTILOS DE T√çTULO PARA MELHOR LEITURA --- */
        h1 {
            text-align: center;
            color: #FFC300; /* Cor Ouro Neon */
            font-size: 38px; 
            margin-bottom: 5px;
            font-weight: 900;
            text-shadow: 0 0 5px #FFC300, 0 0 10px #FFC300, 0 0 20px #FFC300, 2px 2px 5px rgba(0, 0, 0, 1);
            background: rgba(0, 0, 0, 0.4); 
            padding: 5px 15px;
            border-radius: 10px;
        }

        .subtitle {
            text-align: center;
            color: #ECF0F1; /* Texto branco-claro */
            font-size: 19px; 
            margin-bottom: 30px; 
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 1), 0 0 5px rgba(0, 0, 0, 0.8);
            background: rgba(0, 0, 0, 0.6); 
            padding: 8px 18px;
            border-radius: 10px;
        }

        .subtitle strong {
            color: #1ABC9C; 
            font-size: 1.1em;
            text-shadow: 0 0 5px #1ABC9C, 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        /* --- FIM DOS ESTILOS DE T√çTULO --- */

        .score-board {
            display: flex;
            justify-content: center;
            gap: 40px; 
            margin-bottom: 30px; 
            background: transparent; 
            border: 1px solid #FFC300; 
            border-radius: 18px; 
            padding: 15px 30px; 
            box-shadow: 0 0 10px rgba(255, 195, 0, 0.5); 
        }

        .score-item {
            padding: 5px 15px;
            text-align: center;
            min-width: 110px; 
            background: transparent;
            border-radius: 12px;
            box-shadow: 0 0 10px rgba(255, 195, 0, 0.3), inset 0 0 5px rgba(255, 195, 0, 0.2); 
        }

        .score-label {
            color: #BBDEFB;
            font-size: 16px; 
            font-weight: bold;
            margin-bottom: 5px; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
        }

        .score-value {
            color: #E74C3C; 
            font-size: 30px; 
            font-weight: bold;
            text-shadow: 0 0 5px #E74C3C;
        }

        .feedback {
            min-height: 60px; 
            text-align: center;
            font-size: 26px; 
            font-weight: bold;
            margin-bottom: 25px; 
            padding: 10px 20px; 
            border-radius: 15px; 
            opacity: 0;
            transition: opacity 0.4s, background-color 0.4s, transform 0.4s;
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 100%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            z-index: 50;
        }

        .feedback.show {
            opacity: 1;
            transform: scale(1.03); 
        }
        
        /* Cores de feedback */
        .feedback.correct { background: #2ECC71; color: white; box-shadow: 0 0 18px rgba(46, 204, 113, 0.7); }
        .feedback.incorrect { background: #E74C3C; color: white; box-shadow: 0 0 18px rgba(231, 76, 60, 0.7); }
        .feedback.order-error { background: #F39C12; color: white; box-shadow: 0 0 18px rgba(243, 156, 18, 0.7); }
        
        .feedback span.icon { margin-right: 12px; font-size: 1.25em; }

        .feedback .tip {
            font-size: 0.7em; 
            font-weight: normal;
            margin-top: 5px; 
            line-height: 1.3;
        }
        .feedback .correct-tip { color: #D35400; font-weight: bold; }

        /* --- AJUSTE CHAVE PARA VISIBILIDADE --- */
        .game-area {
            background: rgba(44, 62, 80, 0.6); 
            border: 2px solid #FFC300; 
            border-radius: 25px; 
            padding: 30px; 
            margin-bottom: 25px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px; 
            box-shadow: inset 0 0 8px rgba(255, 195, 0, 0.05), 0 2px 8px rgba(0, 0, 0, 0.4); 
            width: 100%; 
            z-index: 20; 
        }

        .options-container {
            display: flex;
            gap: 20px; 
            justify-content: center;
            flex-wrap: wrap;
            padding: 15px; 
            width: 100%; 
        }

        /* --- ESTILO PARA OP√á√ïES ARRAST√ÅVEIS (COM FUNDO BRANCO) --- */
        .draggable-option {
            background: white; 
            border: 3px solid #3498DB; 
            border-radius: 18px; 
            padding: 18px 35px; 
            font-size: 28px; 
            font-weight: bold;
            color: #333; 
            cursor: grab;
            user-select: none;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            min-width: 90px; 
            text-align: center;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.9), inset 0 0 10px rgba(52, 152, 219, 0.6);
            text-shadow: none; 
        }

        .draggable-option:hover {
            transform: translateY(-5px) scale(1.05); 
            background-color: #F8F8F8; 
        }
        
        .draggable-option.dragging {
            opacity: 0.9; 
            transform: scale(1.1) rotate(5deg); 
            background-color: #F0F0F0; 
        }
        
        .game-area.blocked .draggable-option {
            pointer-events: none;
            cursor: default;
            opacity: 0.6;
        }

        .math-operation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px; 
            font-size: 40px; 
            font-weight: bolder;
            color: #ECF0F1; 
            flex-wrap: wrap; 
            position: relative;
            z-index: 25; 
        }

        /* --- AJUSTES DE CORES PARA FUNDO CLARO E BORDAS NEON --- */
        .math-number, .drop-zone { 
            background-color: white; 
            border-radius: 18px; 
            padding: 20px 30px; 
            font-size: 38px; 
            font-weight: bold;
            min-width: 80px; 
            text-align: center;
            color: #333; 
            text-shadow: none; 
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); 
            transition: all 0.3s ease-in-out; 
        }

        /* Estilos para cores individuais dos n√∫meros */
        .math-number.color-green {
            --neon-color: #1ABC9C; 
            border: 3px solid var(--neon-color); 
            box-shadow: 0 0 15px rgba(26, 188, 156, 0.7); 
        }

        .math-number.color-purple {
            --neon-color: #9B59B6; 
            border: 3px solid var(--neon-color); 
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.7); 
        }

        .math-number.color-blue {
            --neon-color: #3498DB; 
            border: 3px solid var(--neon-color); 
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.7); 
        }

        .math-number.color-red {
            --neon-color: #E74C3C; 
            border: 3px solid var(--neon-color); 
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.7); 
        }

        .math-number.color-yellow {
            --neon-color: #F39C12; 
            border: 3px solid var(--neon-color); 
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.7); 
        }
        /* --- FIM DOS AJUSTES DE COR DE N√öMEROS --- */


        /* --- AJUSTES DO OPERADOR --- */
        .math-operator {
            color: #ECF0F1; 
            font-size: 48px; 
            font-weight: bolder;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); 
        }

        /* --- AJUSTES DA DROP-ZONE --- */
        .drop-zone {
            border: 4px dashed #FFC300; 
            color: #FFC300; 
            box-shadow: 0 0 18px rgba(255, 195, 0, 0.5), inset 0 0 10px rgba(255, 195, 0, 0.3); 
            cursor: pointer;
            min-width: 100px;
            height: 70px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone.correct { 
            background: #2ECC71; 
            color: white; 
            border-style: solid; 
            border-color: #1E8449; 
            box-shadow: 0 0 18px rgba(46, 204, 113, 0.8); 
        }
        .drop-zone.incorrect { 
            background: #E74C3C; 
            color: white; 
            border-style: solid; 
            border-color: #C0392B; 
            box-shadow: 0 0 18px rgba(231, 76, 60, 0.8); 
        }
        .drop-zone.order-error { 
            background: #F39C12; 
            border-color: #D35400;
            box-shadow: 0 0 18px rgba(243, 156, 18, 0.8); 
        }
        /* --- FIM DOS AJUSTES DE DROP-ZONE --- */

        .button-container {
            display: flex;
            justify-content: center;
            gap: 25px; 
            margin-top: 30px; 
            flex-wrap: wrap;
            min-height: 60px;
        }
        
        /* Estilos do Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal.show { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, #FDFEFE, #ECF0F1); 
            border: 4px solid #FFC300; 
            border-radius: 30px; 
            padding: 35px; 
            text-align: center;
            max-width: 500px; 
            width: 90%;
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.5); 
            animation: fadeIn 0.6s ease-out;
        }

        .modal-content h2 { color: #E74C3C; font-size: 32px; margin-bottom: 25px; } 
        .modal-content p { color: #555; font-size: 19px; margin: 15px 0; } 
        .modal-content p span { color: #3498DB; font-size: 25px; font-weight: bold; } 
        
        .modal-buttons { display: flex; flex-direction: column; gap: 20px; margin-top: 30px; } 

        .modal-buttons button {
            background: #1ABC9C; 
            color: white;
            border: none;
            border-radius: 18px; 
            padding: 16px 30px; 
            font-size: 19px; 
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); 
            min-width: 280px; 
            text-transform: uppercase;
        }

        .modal-buttons .continue-button { background-color: #2ECC71; }
        .modal-buttons .continue-button:hover { background-color: #28B463; transform: translateY(-3px); } 
        
        .modal-buttons .stop-button { background-color: #F39C12; }
        .modal-buttons .stop-button:hover { background-color: #E67E22; transform: translateY(-3px); }
        
        .modal-buttons .nav-button { background-color: #3498DB; }
        .modal-buttons .nav-button:hover { background-color: #2980B9; transform: translateY(-3px); }

        .modal-buttons .back-button { background-color: #9B59B6; }
        .modal-buttons .back-button:hover { background-color: #8E44AD; transform: translateY(-3px); }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); } 
            to { opacity: 1; transform: scale(1); }
        }
        
        /* --- MEDIA QUERIES --- */
        @media (max-width: 768px) {
            .feedback { font-size: 22px; min-height: 55px; }
            .feedback .tip { font-size: 0.65em; }
            .math-operation { font-size: 32px; gap: 20px; }
            .math-number { font-size: 32px; padding: 15px 25px; min-width: 70px; } 
            .math-operator { font-size: 40px; }
            .drop-zone { font-size: 32px; padding: 12px 25px; min-width: 80px; height: 60px; } 
            .draggable-option { font-size: 24px; padding: 15px 30px; min-width: 80px; } 
            .game-container { padding: 25px; }
            .score-board { gap: 25px; padding: 12px 20px; }
        }

        @media (max-width: 480px) {
            h1 { font-size: 30px; }
            .subtitle { font-size: 16px; margin-bottom: 20px; }
            .feedback { font-size: 18px; min-height: 40px; padding: 8px 10px; margin-bottom: 15px; }
            .feedback .tip { font-size: 0.55em; }
            .game-container { padding: 15px; }
            .score-board { gap: 15px; padding: 10px 15px; }
            .score-label { font-size: 14px; }
            .score-value { font-size: 24px; }
            .game-area { padding: 20px; gap: 20px; }
            .options-container { gap: 10px; padding: 10px; }
            .draggable-option { font-size: 20px; padding: 12px 25px; min-width: 70px; } 
            .math-operation { font-size: 24px; gap: 15px; }
            .math-number { font-size: 26px; padding: 12px 20px; min-width: 60px; } 
            .math-operator { font-size: 30px; }
            .drop-zone { font-size: 26px; padding: 10px 20px; min-width: 70px; height: 55px; } 
            .modal-content { padding: 20px; max-width: 350px; }
            .modal-content h2 { font-size: 24px; margin-bottom: 15px; }
            .modal-buttons button { padding: 14px 25px; font-size: 17px; min-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Hora da Matem√°tica Divertida! ü§©</h1>
        <p class="subtitle">Lembre-se: <strong>Multiplica√ß√£o (x) ou Divis√£o (√∑) sempre primeiro!</strong> Arraste o n√∫mero para o resultado.</p>
        
        <div class="score-board">
            <div class="score-item">
                <div class="score-label">Acertos:</div>
                <div class="score-value" id="correct">0/5</div>
            </div>
            <div class="score-item">
                <div class="score-label">Erros:</div>
                <div class="score-value" id="errors">0</div>
            </div>
        </div>

        <div class="feedback" id="feedback"></div>

        <div class="game-area" id="gameArea">
            <div class="options-container" id="optionsContainer">
                
</div>

            <div class="math-operation">
                <div class="math-number color-green" id="num1">?</div>
                <div class="math-operator" id="operator1">?</div>
                <div class="math-number color-purple" id="num2">?</div>
                <div class="math-operator" id="operator2">?</div>
                <div class="math-number color-blue" id="num3">?</div>
                <div class="math-operator">=</div>
                <div class="drop-zone" id="dropZone">?</div>
            </div>

            <div class="button-container">
                
</div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Meta Atingida! üéâ</h2>
            <p id="modalRoundCorrect" style="display:none;">Acertos na Rodada: <span id="modalCorrect">0</span></p>
            <p id="modalRoundErrors" style="display:none;">Erros na Rodada: <span id="modalErrors">0</span></p>
            
            <div class="modal-buttons" id="modalButtonsContinue">
                
</div>
            
            <div class="modal-buttons" id="modalButtonsFinal" style="display: none;">
                
</div>
            
        </div>
    </div>

    <script>
        // Vari√°veis de estado do jogo
        let currentQuestionData = null; 
        let correctAnswersCurrentRound = 0; 
        let errorsCurrentRound = 0; 
        let draggedElement = null;
        let answered = false;
        let isDragging = false;
        
        const TARGET_SCORE = 1; 
        const MAX_RESULT = 20; 
        const MAX_NUMBER = 12; 
        // Aumentado de 40 para 60 para dar mais margem de manobra na gera√ß√£o de problemas
        const MAX_INTERMEDIATE_VALUE = 60; 
        const NEXT_QUESTION_DELAY = 1000; 
        const ERROR_FEEDBACK_DELAY = 2000; 
        
        // Operadores
        const HIGH_PRIORITY = ['x', '√∑'];
        const LOW_PRIORITY = ['+', '-'];
        
        let totalCorrectOverall = 0;
        let totalErrorsOverall = 0;
        let totalAttemptsOverall = 0;
        
        // --- ELEMENTOS DOM ---
        const dropZone = document.getElementById('dropZone');
        const gameArea = document.getElementById('gameArea');
        const optionsContainer = document.getElementById('optionsContainer');
        const feedbackEl = document.getElementById('feedback'); 
        const correctScoreDisplay = document.getElementById('correct');
        const errorsScoreDisplay = document.getElementById('errors');

        const num1Display = document.getElementById('num1');
        const operator1Display = document.getElementById('operator1');
        const num2Display = document.getElementById('num2');
        const operator2Display = document.getElementById('operator2');
        const num3Display = document.getElementById('num3');

        // --- FUN√á√ïES DE C√ÅLCULO ---
        
        function evaluateOperation(a, op, b) {
            if (op === '+') return a + b;
            if (op === '-') {
                // Garante resultado n√£o-negativo para subtra√ß√£o
                if (a < b) return null; 
                return a - b;
            }
            if (op === 'x') return a * b;
            if (op === '√∑') {
                // Garante divis√£o por zero e divis√µes que resultem em inteiros
                if (b === 0 || a % b !== 0) return null; 
                return a / b;
            }
            return null;
        }

        function evaluateStandardPrecedence(n1, op1, n2, op2, n3) {
            const isOp1High = HIGH_PRIORITY.includes(op1);
            const isOp2High = HIGH_PRIORITY.includes(op2);
            
            let partialResult = null;
            let finalResult = null;

            // Caso 1 e 4: Mesma Prioridade (Left-to-Right)
            if (isOp1High === isOp2High) {
                return calculateLeftToRight(n1, op1, n2, op2, n3);
            }
            // Caso 2: Op1 alta, Op2 baixa (Executa Op1 primeiro)
            else if (isOp1High && !isOp2High) {
                partialResult = evaluateOperation(n1, op1, n2);
                if (partialResult === null || partialResult > MAX_INTERMEDIATE_VALUE) return null;
                finalResult = evaluateOperation(partialResult, op2, n3);
            } 
            // Caso 3: Op1 baixa, Op2 alta (Executa Op2 primeiro)
            else if (!isOp1High && isOp2High) {
                partialResult = evaluateOperation(n2, op2, n3);
                if (partialResult === null || partialResult > MAX_INTERMEDIATE_VALUE) return null;
                finalResult = evaluateOperation(n1, op1, partialResult);
            } 
            
            return (finalResult !== null && Number.isInteger(finalResult) && finalResult >= 0 && finalResult <= MAX_RESULT) ? finalResult : null;
        }

        function calculateLeftToRight(n1, op1, n2, op2, n3) {
            const tempResult1 = evaluateOperation(n1, op1, n2);
            if (tempResult1 === null || tempResult1 > MAX_INTERMEDIATE_VALUE) return null;
            
            const finalResult = evaluateOperation(tempResult1, op2, n3);
            
            if (finalResult !== null && Number.isInteger(finalResult) && finalResult >= 0 && finalResult <= MAX_RESULT) {
                return finalResult;
            }
            return null;
        }
        
        // --- FUN√á√ÉO DE GERA√á√ÉO DE PERGUNTA (AJUSTADA) ---
        function generateQuestion() {
            const allOps = HIGH_PRIORITY.concat(LOW_PRIORITY);
            let n1, n2, n3, op1, op2, result, wrongOrderResult;
            let attempts = 0;
            const MAX_ATTEMPTS = 5000; 

            while (attempts < MAX_ATTEMPTS) {
                attempts++;
                
                // 1. Gera√ß√£o de Operadores: For√ßar conflito na maioria das vezes.
                op1 = allOps[Math.floor(Math.random() * allOps.length)];
                op2 = allOps[Math.floor(Math.random() * allOps.length)];

                const isOp1High = HIGH_PRIORITY.includes(op1);
                const isOp2High = HIGH_PRIORITY.includes(op2);
                const isConflict = isOp1High !== isOp2High;

                // For√ßa o conflito na maioria das vezes para focar no aprendizado
                if (!isConflict && attempts < MAX_ATTEMPTS * 0.9) { continue; } 
                
                // 2. Gera√ß√£o de N√∫meros Aleat√≥rios
                n1 = Math.floor(Math.random() * MAX_NUMBER) + 1; 
                n2 = Math.floor(Math.random() * MAX_NUMBER) + 1; 
                n3 = Math.floor(Math.random() * MAX_NUMBER) + 1; 
                
                // --- AJUSTES: Divis√£o e Subtra√ß√£o para Garantir Inteiros e Ordem ---
                
                // 2a. Ajuste para Divis√£o (Op2 tem que ser um divisor de n2)
                if (op2 === '√∑') {
                    if (n3 === 0) continue; 
                    // n2 se torna o m√∫ltiplo de n3 mais pr√≥ximo (para baixo)
                    n2 = Math.floor(n2 / n3) * n3;
                    if (n2 === 0 || n2 < n3) continue; // Garante que o dividendo seja >= divisor e > 0
                }
                
                // 2b. Ajuste para Divis√£o (Op1: n1 op1 n2)
                if (op1 === '√∑') {
                    // Se op2 tamb√©m era '√∑', pulamos para evitar problemas de depend√™ncia complexa
                    if (op2 === '√∑') continue; 
                    
                    if (n2 === 0) continue;
                    // n1 se torna o m√∫ltiplo de n2 mais pr√≥ximo (para baixo)
                    n1 = Math.floor(n1 / n2) * n2;
                    if (n1 === 0 || n1 < n2) continue; // Garante que o dividendo seja >= divisor e > 0
                }
                
                // 2c. Ajuste para Subtra√ß√£o: Garante que a primeira opera√ß√£o LeftToRight n√£o seja negativa.
                if (op1 === '-' && n1 < n2) { [n1, n2] = [n2, n1]; }


                // 3. C√°lculo e Verifica√ß√£o
                result = evaluateStandardPrecedence(n1, op1, n2, op2, n3);
                wrongOrderResult = calculateLeftToRight(n1, op1, n2, op2, n3);

                // Condi√ß√£o de sucesso: Ambos os resultados s√£o v√°lidos E s√£o diferentes (garante o conflito de preced√™ncia).
                if (result !== null && wrongOrderResult !== null && result !== wrongOrderResult) {
                    return { num1: n1, operator1: op1, num2: n2, operator2: op2, num3: n3, correctAnswer: result, wrongOrderResult: wrongOrderResult };
                }
            }
            // Fallback caso o loop n√£o consiga gerar um problema v√°lido
            console.warn("N√£o foi poss√≠vel gerar uma pergunta v√°lida e com conflito. Usando Fallback.");
            return { num1: 10, operator1: '+', num2: 4, operator2: 'x', num3: 2, correctAnswer: 18, wrongOrderResult: 28 };
        }


        function loadQuestion() {
            if (correctAnswersCurrentRound >= TARGET_SCORE) {
                showRoundCompletionModal();
                return;
            }

            answered = false;
            draggedElement = null;
            gameArea.classList.remove('blocked');
            dropZone.classList.remove('correct', 'incorrect', 'order-error');
            dropZone.textContent = '?';
            
            feedbackEl.classList.remove('show', 'correct', 'incorrect', 'order-error');
            feedbackEl.textContent = '';

            const question = generateQuestion();
            currentQuestionData = question; 
            
            num1Display.textContent = question.num1;
            operator1Display.textContent = question.operator1;
            num2Display.textContent = question.num2;
            operator2Display.textContent = question.operator2;
            num3Display.textContent = question.num3;
            
            const correctAnswer = question.correctAnswer;
            const options = [correctAnswer];

            if (question.wrongOrderResult !== null && !options.includes(question.wrongOrderResult)) {
                options.push(question.wrongOrderResult);
            }
            
            // Gera√ß√£o de op√ß√µes aleat√≥rias (respeita MAX_RESULT)
            while (options.length < 3) {
                const randomOption = Math.floor(Math.random() * (MAX_RESULT + 1)); 
                
                if (randomOption >= 0 && !options.includes(randomOption)) {
                    options.push(randomOption);
                }
            }
            options.sort(() => Math.random() - 0.5);

            optionsContainer.innerHTML = '';
            options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'draggable-option';
                optionEl.textContent = option;
                optionEl.draggable = true;
                optionEl.dataset.value = option;
                optionEl.dataset.correct = option === correctAnswer; 
                
                optionEl.addEventListener('dragstart', handleDragStart);
                optionEl.addEventListener('dragend', handleDragEnd);
                optionEl.addEventListener('touchstart', handleTouchStart);
                optionEl.addEventListener('touchmove', handleTouchMove);
                optionEl.addEventListener('touchend', handleTouchEnd);
                
                optionsContainer.appendChild(optionEl);
            });
            
            updateScoreDisplays();
        }

        function updateScoreDisplays() {
            correctScoreDisplay.textContent = `${correctAnswersCurrentRound}/${TARGET_SCORE}`;
            errorsScoreDisplay.textContent = errorsCurrentRound;
        }

        function checkAnswer(selectedValue) {
            if (answered) return;
            
            answered = true;
            gameArea.classList.add('blocked');
            
            dropZone.textContent = selectedValue;
            
            totalAttemptsOverall++; 
            
            const isCorrect = selectedValue === currentQuestionData.correctAnswer;
            const isWrongOrder = selectedValue === currentQuestionData.wrongOrderResult;

            if (isCorrect) {
                correctAnswersCurrentRound++;
                totalCorrectOverall++; 
                dropZone.classList.add('correct');
                
                feedbackEl.innerHTML = '<span class="icon">ü•≥</span> **Certo!** Voc√™ usou a regra de preced√™ncia.';
                feedbackEl.classList.remove('incorrect', 'order-error');
                feedbackEl.classList.add('correct', 'show');
                
                // Remove o elemento arrastado permanentemente
                if (draggedElement) {
                    draggedElement.remove(); 
                }
                
                // AVAN√áA AUTOMATICAMENTE AP√ìS O ACERTO (1 SEGUNDO)
                setTimeout(goToNextQuestion, NEXT_QUESTION_DELAY); 

            } else {
                errorsCurrentRound++;
                totalErrorsOverall++; 
                
                if (isWrongOrder) {
                    dropZone.classList.add('incorrect', 'order-error');
                    feedbackEl.innerHTML = `
                        <span class="icon">ü§î</span> Quase! Voc√™ fez da esquerda para a direita.
                        <span class="tip">
                            **Regra de Ouro:** Primeiro fa√ßa a multiplica√ß√£o/divis√£o, depois a soma/subtra√ß√£o.
                            O resultado correto era: <span class="correct-tip">${currentQuestionData.correctAnswer}</span>
                        </span>
                    `;
                    feedbackEl.classList.remove('correct', 'incorrect');
                    feedbackEl.classList.add('order-error', 'show');
                } else {
                    dropZone.classList.add('incorrect');
                    feedbackEl.innerHTML = `
                        <span class="icon">üòî</span> N√∫mero errado. O resultado correto, aplicando a regra, era:
                        <span class="tip">
                            **Regra de Ouro:** Primeiro fa√ßa a multiplica√ß√£o/divis√£o, depois a soma/subtra√ß√£o.
                            O resultado correto √©: <span class="correct-tip">${currentQuestionData.correctAnswer}</span>
                        </span>
                    `;
                    feedbackEl.classList.remove('correct', 'order-error');
                    feedbackEl.classList.add('incorrect', 'show');
                }
                
                // Se errou, recoloca a op√ß√£o na lista *apenas visualmente*
                if (draggedElement) {
                    draggedElement.style.position = '';
                    draggedElement.style.left = '';
                    draggedElement.style.top = '';
                    draggedElement.classList.remove('dragging');
                    optionsContainer.appendChild(draggedElement); 
                }
                
                // AVAN√áA AUTOMATICAMENTE AP√ìS O ERRO (2 SEGUNDOS DE DELAY PARA LEITURA)
                setTimeout(goToNextQuestion, ERROR_FEEDBACK_DELAY); 
            }
            
            updateScoreDisplays();
        }
        
        function goToNextQuestion() {
            dropZone.classList.remove('correct', 'incorrect', 'order-error');
            feedbackEl.classList.remove('show', 'correct', 'incorrect', 'order-error');
            feedbackEl.textContent = '';
            loadQuestion();
        }


        // --- FUN√á√ïES DRAG AND DROP E TOUCH ---
        
        function handleDragStart(e) {
            if(answered) { e.preventDefault(); return; }
            draggedElement = e.target;
            e.dataTransfer.setData('text/plain', e.target.textContent);
            e.target.classList.add('dragging');
            setTimeout(() => { e.target.style.visibility = 'hidden'; }, 0);
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            if (e.target.style.visibility === 'hidden' && !answered) {
                e.target.style.visibility = 'visible'; 
            }
        }

        function handleDragOver(e) {
            if(!answered) {
                e.preventDefault();
                e.currentTarget.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');

            if (answered || !draggedElement) return;
            
            const selectedValue = parseInt(e.dataTransfer.getData('text/plain'));
            checkAnswer(selectedValue); 
        }
        
        let touchStartPos = { x: 0, y: 0 };
        const MOVE_THRESHOLD = 5; 

        function handleTouchStart(e) {
            if (answered) { e.preventDefault(); return; }
            
            isDragging = false;
            draggedElement = e.target;
            
            const touch = e.touches[0];
            touchStartPos = { x: touch.clientX, y: touch.clientY };
            
            draggedElement.classList.add('dragging'); 
            const rect = draggedElement.getBoundingClientRect();
            draggedElement.startX = touch.clientX - rect.left;
        }

        function handleTouchMove(e) {
            if (answered) { e.preventDefault(); return; }
            
            const touch = e.touches[0];
            const dx = touch.clientX - touchStartPos.x;
            const dy = touch.clientY - touchStartPos.y;

            if (Math.abs(dx) > MOVE_THRESHOLD || Math.abs(dy) > MOVE_THRESHOLD) {
                isDragging = true;
                e.preventDefault(); 
            } else {
                return;
            }
            
            draggedElement.style.position = 'absolute';
            draggedElement.style.left = `${touch.clientX - draggedElement.startX}px`;
            draggedElement.style.top = `${touch.clientY - (draggedElement.offsetHeight / 2)}px`;
        }

        function handleTouchEnd(e) {
            if (answered) return;
            draggedElement.classList.remove('dragging');

            if (isDragging) {
                const touch = e.changedTouches[0];
                const dropRect = dropZone.getBoundingClientRect();

                if (touch.clientX > dropRect.left && touch.clientX < dropRect.right &&
                    touch.clientY > dropRect.top && touch.clientY < dropRect.bottom) {
                    
                    const selectedValue = parseInt(draggedElement.dataset.value);
                    checkAnswer(selectedValue);

                } else {
                    // Retorna para a posi√ß√£o original na lista
                    draggedElement.style.position = '';
                    draggedElement.style.left = '';
                    draggedElement.style.top = '';
                    draggedElement.style.visibility = 'visible';
                }
            } else {
                // Se foi um toque r√°pido (n√£o arrastado), faz nada
            }

            draggedElement = null;
            isDragging = false;
        }

        // --- FUN√á√ïES DE MODAL ---
        
        function showRoundCompletionModal() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalCorrectDisplay = document.getElementById('modalCorrect');
            const modalErrorsDisplay = document.getElementById('modalErrors');
            const modalButtonsContinue = document.getElementById('modalButtonsContinue');
            const modalButtonsFinal = document.getElementById('modalButtonsFinal');

            modalTitle.textContent = "Parab√©ns! Rodada Conclu√≠da! üéâ";
            modalCorrectDisplay.textContent = correctAnswersCurrentRound;
            modalErrorsDisplay.textContent = errorsCurrentRound;
            document.getElementById('modalRoundCorrect').style.display = 'block';
            document.getElementById('modalRoundErrors').style.display = 'block';

            modalButtonsContinue.innerHTML = `
                <button class="continue-button" onclick="startNewRound()">Jogar Mais Uma Rodada</button>
                <button class="nav-button" onclick="window.location.href='../index.html'">Voltar ao Menu Principal</button>
            `;
            modalButtonsContinue.style.display = 'flex';
            modalButtonsFinal.style.display = 'none';

            modal.classList.add('show');
        }

        function startNewRound() {
            document.getElementById('modal').classList.remove('show');
            correctAnswersCurrentRound = 0;
            errorsCurrentRound = 0;
            loadQuestion();
        }

        // --- EVENT LISTENERS E INICIALIZA√á√ÉO ---

        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);

        // Inicializa a primeira pergunta
        loadQuestion();
    </script>
</body>
</html>